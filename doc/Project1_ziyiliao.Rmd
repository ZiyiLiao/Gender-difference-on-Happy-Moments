---
title: "Project 1"
author: 'Ziyi Liao '
output:
  html_notebook: default
  pdf_document: default
---

## Part 0: Clean the data
#### Step 1. load the libraries 
```{r, message=FALSE}
library(tm)
library(plyr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(readr)
library(stringr)
library(scales)
library(tidytext)
library(textdata)
library(ngram)
library(forcats)
library(syuzhet)
library(wordcloud)
library(reshape2)
```

```{r load libraries, warning=FALSE, message=FALSE}

library(DT)

library(gridExtra)

library(topicmodels)
```

#### Step 2: Process the data
```{r message=FALSE, warning=FALSE}
# This data is processed from Text_Pre-processing file
hm_data <- read_csv("../data/output/processed_moments.csv")

urlfile<-'https://raw.githubusercontent.com/rit-public/HappyDB/master/happydb/data/demographic.csv'
demo_data <- read_csv(urlfile)
```
```{r}
## Select the data
happydb <- hm_data %>%
  inner_join(demo_data, by = "wid") %>%
  select(wid,
         original_hm,
         gender, 
         marital, 
         parenthood,
         reflection_period,
         age,
         country,
         cleaned_hm,
         ground_truth_category) %>%
  mutate(count = sapply(hm_data$text, wordcount)) %>%
  filter(gender %in% c("m", "f")) %>%
  filter(marital %in% c("single", "married")) %>%
  filter(parenthood %in% c("n", "y")) %>%
  filter(reflection_period %in% c("24h", "3m")) %>%
  mutate(reflection_period = fct_recode(reflection_period, 
                                        months_3 = "3m", hours_24 = "24h"))

# Merge the text data with demographic data into a CSV file
# write_csv(happydb, "../data/output/happydb.csv")
happydb = read.csv("../data/output/happydb.csv")

#convert the structures of some variables
happydb$age <- as.numeric(happydb$age)
```


## Part 1: What's the difference of the words in each gender group?
In order to analyze the components of the text in each group, the barplot and wordcloud are used.
#### Step 1 : Filter data
```{r,warning=FALSE}
female <- happydb %>%
  filter(gender == 'f') 
male <- happydb %>%
  filter(gender == 'm')

urlfile<-'https://raw.githubusercontent.com/rit-public/HappyDB/master/happydb/data/senselabel.csv'
sense_data <- read.csv(urlfile, stringsAsFactors = F)
```

* Remove Stopwords
```{r}
data("stop_words")

word <- c("happy","ago","yesterday","lot","today","months","month",
                 "happier","happiest","last","week","past","day")

stop_words <- stop_words %>%
  bind_rows(mutate(tibble(word), lexicon = "updated"))
```
```{r}

# females' answer word cleaning
female_text <- female$cleaned_hm %>% as.vector()  %>% 
  tibble(text = .) %>% 
  unnest_tokens(word, text) %>% 
  anti_join(stop_words)

# males' answer word cleaning
male_text <- male$cleaned_hm %>% as.vector()  %>% 
  tibble(text = .) %>% 
  unnest_tokens(word, text) %>% 
  anti_join(stop_words)
```

#### Step 2: Word Frequency 

* Each gender's word frequency
```{r}
freq_f <- female_text %>% count(word, sort = TRUE) # count frequency and sort by descending order
freq_m <- male_text %>% count(word, sort = TRUE) # count frequency and sort by descending order

# visualize the frequency
freq_f %>%
  filter(n > 1500) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n)) +
  geom_col(fill = "pink") +
  xlab(NULL) +
  ggtitle("Female word frequency")+
  coord_flip()

freq_m %>%
  filter(n > 1500) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n)) +
  geom_col(fill= "skyblue") +
  xlab(NULL) +
  ggtitle("Male word frequency")+
  coord_flip()
```

* Combination of gender word frequency
```{r}
# join each gender's word frequency 
frequency <- bind_rows(mutate(freq_f, gender = "Female"),
                       mutate(freq_m, gender = "Male")) %>%
   mutate(word = str_extract(word, "[a-z']+")) %>%
   count(gender, word) %>%
   group_by(gender) %>%
   mutate(proportion = n / sum(n)) %>%
   select(-n) %>%  # delete n var
   spread(gender, proportion) %>%  # word female male as columns
   gather(gender, proportion, `Male`) %>% drop_na()
```

```{r}
ggplot(frequency, aes(x = proportion, y = `Female`, color = abs(`Female` - proportion))) +
  geom_abline(color = "gray40", lty = 2) +
  geom_jitter(alpha = 0.1, size = 2.5, width = 0.3, height = 0.3) +
  geom_text(aes(label = word), check_overlap = TRUE, vjust = 1.5) +
  scale_x_log10(labels = percent_format()) +
  scale_y_log10(labels = percent_format()) +
  scale_color_gradient(limits = c(0, 0.001), low = "darkslategray4", high = "gray75") +
  facet_wrap(~gender, ncol = 2) +
  theme(legend.position="none") +
  labs(y = "Female", x = NULL)
```
Words that are close to the line in these plots have similar frequencies in both sets of texts, which means there is huge similarity between females' response and males' response

* Combine with position
```{r}
# combine with position 
pos <- sense_data %>%
  select(lowercaseLemma, POS) %>% 
  rename(word = lowercaseLemma)  %>% 
  unique()

pos_f <- freq_f %>% inner_join(pos) %>% 
  group_by(POS) %>% 
  summarise(n = sum(n)) %>% 
  mutate(proportion = n /sum(n))

pos_m  <- freq_m %>% inner_join(pos)  %>% 
  group_by(POS) %>% 
  summarise(n= sum(n)) %>% 
  mutate(proportion = n /sum(n))
```

```{r}
pos_f %>%
  mutate(POS = reorder(POS, proportion)) %>%
  ggplot(aes(POS, proportion)) +
  geom_col(fill = "pink") +
  xlab(NULL) +
  ggtitle("Female Part of Speech Proportion")+
  coord_flip()

pos_m %>%
  mutate(POS = reorder(POS, proportion)) %>%
  ggplot(aes(POS, proportion)) +
  geom_col(fill = "skyblue") +
  xlab(NULL) +
  ggtitle("Male Part of Speech Proportion")+
  coord_flip()
```


#### Sentiment Analysis

* Positive vs. Negative
```{r}
# obtained sentiment
bing = get_sentiments("bing")

female_sentiment <- female_text %>% inner_join(bing)) %>%
  count(word, sentiment, sort = TRUE) %>%
  ungroup()

female_sentiment %>%
  group_by(sentiment) %>%
  top_n(10) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scales = "free_y") +
  labs(y = "Contribution to sentiment",
       x = NULL) +
  coord_flip()

male_sentiment <- male_text %>% inner_join(bing) %>%
  count(word, sentiment, sort = TRUE) %>%
  ungroup()

male_sentiment %>%
  group_by(sentiment) %>%
  top_n(10) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scales = "free_y") +
  labs(y = "Contribution to sentiment",
       x = NULL) +
  coord_flip()

```
The top 10 words in positive and negative aspect don't differ from each gender, just the order changed.

* WordCloud of text word
```{r}
### General Word Cloud

# palatte
colorVec_f = rep(c('red', 'lightpink'), length.out=nrow(freq_f))

freq_f %>% with(wordcloud(word, n, max.words = 100, colors =colorVec_f))

# palatte
colorVec_m = rep(c('blue', 'skyblue'), length.out=nrow(freq_m))

freq_m %>% with(wordcloud(word, n, max.words = 100, colors =colorVec_m))
```
```{r}
female_text %>%
  inner_join(bing) %>%
  count(word, sentiment, sort = TRUE) %>%
  acast(word ~ sentiment, value.var = "n", fill = 0) %>%
  comparison.cloud(colors = c("grey20", "pink"),
                   max.words = 100)


male_text %>%
  inner_join(bing) %>%
  count(word, sentiment, sort = TRUE) %>%
  acast(word ~ sentiment, value.var = "n", fill = 0) %>%
  comparison.cloud(colors = c("gray20", "skyblue"),
                   max.words = 100)
```

#### Summary
The barplots show that both male and female like use nouns, verbs and adjs to express the happy moments. The top 10 words of frequency in each groups also support the notation. Women have 8 nouns and 2 verbs and man have 7 nouns, 2 verbs and 1 adverb(finally).

In the barplot and wordcloud graphs of both female and male, we can find that both women and men are enjoyed the happy moments with their friends. But women tend to be more bond with people around them for the words like husband, daughter, son, family come up more frequently than men's. 


## Part 2: What's the difference of the periods in each gender group?
For the infomation of the difference in the numbers and contents of periods in each gender group, I'm gonna use the number count, word cloud and ks-test.
#### Step 1. Numbers of reflection
```{r}
ggplot(happydb,aes(x = happydb$gender,fill = happydb$reflection_period))+
  geom_bar(position = "fill") +
  labs(title = 'Reflection Period of Different Gender', x = 'Gender')
```

#### Step 2. Part of Position of Reflection
```{r}
# filter all the data set
female_24h <- female %>%
  filter(reflection_period == 'hours_24') # female & 24h
freq_f24h <- Corpus(VectorSource(female_24h$text)) %>%
  DocumentTermMatrix() %>%
  as.matrix() %>% colSums() %>% data.frame()
freq_f24h <- order(freq_f24h$., decreasing = T) %>%
  data.frame(word = rownames(freq_f24h)[.], Freq = freq_f24h[.,])

female_3m <- female %>%
  filter(reflection_period == 'months_3') # female & 3m
freq_f3m <- Corpus(VectorSource(female_3m$text)) %>% 
  DocumentTermMatrix() %>%
  as.matrix() %>% colSums() %>%  data.frame()
freq_f3m <- order(freq_f3m$., decreasing = T) %>%
  data.frame(word = rownames(freq_f3m)[.], Freq = freq_f3m[.,])
```

```{r}
male_24h <- male %>%
  filter(reflection_period == 'hours_24') # male & 24h
freq_m24h <- Corpus(VectorSource(male_24h$text)) %>% 
  DocumentTermMatrix() %>%
  as.matrix() %>% colSums() %>% data.frame()
freq_m24h <- order(freq_m24h$., decreasing = T) %>%
  data.frame(word = rownames(freq_m24h)[.], Freq = freq_m24h[.,])
male_3m <- male %>%
  filter(reflection_period == 'months_3') # male & 3m
freq_m3m <- Corpus(VectorSource(male_3m$text)) %>% 
  DocumentTermMatrix() %>%
  as.matrix() %>% colSums() %>% data.frame()
freq_m3m <- order(freq_m3m$., decreasing = T) %>%
  data.frame(word = rownames(freq_m3m)[.], Freq = freq_m3m[.,])
```

```{r, warning=FALSE}
f24h_POS <- merge(freq_f24h,sense_data,by.x = 'word',by.y = 'lowercaseLemma')
f24h_POS <- as.matrix(table(f24h_POS$POS))

f3m_POS <- merge(freq_f3m,sense_data,by.x = 'word',by.y = 'lowercaseLemma')
f3m_POS <- as.matrix(table(f3m_POS$POS))

m24h_POS <- merge(freq_m24h,sense_data,by.x = 'word',by.y = 'lowercaseLemma')
m24h_POS <- as.matrix(table(m24h_POS$POS))

m3m_POS <- merge(freq_m3m,sense_data,by.x = 'word',by.y = 'lowercaseLemma')
m3m_POS <- as.matrix(table(m3m_POS$POS))

#combine the female data and male data
f.POS <- cbind(f24h_POS,f3m_POS)
m.POS <- cbind(m24h_POS,m3m_POS)


#use the ks.test
ks.test(f.POS[,1],f.POS[,2]);ks.test(m.POS[,1],m.POS[,2])
```

#### Step 3. Words of Reflection
```{r}
# 24h happy moments of female
colorVec1 <- rep(c('palevioletred', 'hotpink'), length.out=nrow(freq_f24h))
wordcloud2(freq_f24h[3:100,2:3], color = colorVec1, fontWeight = "bold",size=0.5, rotateRatio = 0.2) 
```
```{r}
# 3m happy moments of female
colorVec2 <- rep(c('palevioletred', 'hotpink'), length.out=nrow(freq_f3m))
wordcloud2(freq_f3m[3:100,2:3], color = colorVec2, fontWeight = "bold",size=0.5, rotateRatio = 0.2)
```
```{r}
# 24h happy moments of male
colorVec3 <- rep(c('cornflowerblue','skyblue'), length.out=nrow(freq_m24h))
wordcloud2(freq_m24h[3:100,2:3], color = colorVec3, fontWeight = "bold",size=0.5, rotateRatio = 0.2)  
```
```{r}
# 3m happy moments of male
colorVec4 <- rep(c('cornflowerblue','skyblue'), length.out=nrow(freq_m24h))
wordcloud2(freq_m3m[3:100,2:3], color = colorVec4, fontWeight = "bold",size=0.5, rotateRatio = 0.2)
```

#### Summary 
For both female and male, there is no difference in the total number of the reflection period. But with the content of each period, female and male show differently.

Since the p-values of Kolmogorov-Smirnov test are very close to 1, the null hypothesis cannot be rejected at 0.01 significance which means there is no statistically difference between the POS of 24 hours and that of 3 months in each gender group.

After removing the most frequently used words in each group, the results show that in 24-hour's memory, women have more 'fleeting' words - words describing movement, such as watched, feel, enjoy, ect. In 3-month's memory, women have more nouns describing the person they shared the happy moments with. This is compatible with the memory loss. But focusing on men's words in different reflection period, the POS of the words seem remain.


## Part 3: Get Sentiment
It takes really long time to process whole data, so let's just take a sample of it. In this part, the get_nrc_sentiment,get_sent_value, barplot and ks.test will be used.
#### Step 1. Get NRC sentiment
```{r, warning =FALSE, message=FALSE}
sense <- read_csv('../data/sense.csv')
```
```{r plot = TRUE}
sense_f <- sense %>%
  filter(gender == 'f') 
sense_m <- sense %>%
  filter(gender == 'm') 

#take a sample
set.seed(0)
index <- sample(1:nrow(sense_f), 1000)
sense_f_samps <- sense_f[index,]
gns_f <- get_nrc_sentiment(sense_f_samps$lowercaseLemma)
sense_f_count <- apply(gns_f,2,sum)

index2 <- sample(1:nrow(sense_m), 1000)
sense_m_samps <- sense_m[index2,]
gns_m <- get_nrc_sentiment(sense_m_samps$lowercaseLemma)
sense_m_count <- apply(gns_m,2,sum)


# Combine them together
sense_count <- data_frame(sense = rep(names(sense_f_count),2), count = c(sense_f_count, sense_m_count), gender = c(rep('female', length(sense_f_count)), rep('male',length(sense_m_count))))
```

#### Step 2. Draw plots
```{r barplot}
ggplot(sense_count) +
  geom_bar(aes(x = reorder(sense_count$sense,-sense_count$count), y = sense_count$count), stat="identity", fill = 'darkseagreen')+
  facet_grid(~gender)+
  labs(title='Sense of the Happy Moment', y = 'Frequency', x = 'Sense')
```
```{r histogram}
#prepare the data set
sent_value <- function(wid.df){
  return(get_sent_values(wid.df$lowercaseLemma))
}
sent_value_f <- ddply(sense_f_samps, .(wid), sent_value)
sent_value_m <- ddply(sense_m_samps, .(wid), sent_value)

#use histogram to see the distribution of the values of sentiment in each group
ggplot(data = sent_value_f)+
  geom_histogram(mapping = aes(x = sent_value_f$V1, y = ..density..), fill = 'pink', bins = 50) +
  labs(title = 'Female', x = 'Values of Sentiment')
ggplot(data = sent_value_m)+
  geom_histogram(mapping = aes(x = sent_value_m$V1, y = ..density..), fill = 'skyblue', bins = 50) +
  labs(title = 'Male', x = 'Values of Sentiment')
```

#### Step 3. KS test
```{r}
#ks.test of numbers of nrc sentiment of each group
ks.test(sense_count$count[sense_count$gender == 'female'], sense_count$count[sense_count$gender == 'male'])

#ks.test of sentiment values of each group
ks.test(sent_value_f$V1,sent_value_m$V1)
```

#### Summary
Both female and male use more positive words than negative words to express their happy moments. For the sense of words, the words which show joy and anticipation are more likely used for happy moments. The histogram shows both mean of the sentiment values are concerntrated on 0. Under the ks.test, there is no significantly difference between the sense used by women and that by man. 

## Part 4: Conclusion
From the analysis above, we can firstly know that the happy moments are mostly postive which is confirmed with the name of the research 'Happy Moments'. Both women and men used nouns, verbs and adjectives to express their happy moments. Besides, women like to remember the people who spent the happy moments with them but men don't show the tendency.

There is no statistically difference between the numbers of happy moments of different period in each gender group.But the content of the word used by females and males show difference. Women tends to use verbs or adjectives to describe their happy moment in short-term memories, more nouns for discription in longer-term memories while men don't show the same tendency.


